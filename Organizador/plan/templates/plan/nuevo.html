{% extends 'plan/base.html' %}
{% load static %}

{% block extra_head %}
<title>Agregar nuevo plan</title>
<link rel="stylesheet" href="{% static 'plan/css/form.css' %}">
{% endblock extra_head %}

{% block content %}
<h1>Agregar nuevo plan</h1>

<div class="form-container">
  <form method="POST">
    {% csrf_token %}

    <div class="form-group">
      <label for="{{ form.title.id_for_label }}">Título</label>
      {{ form.title }}
    </div>

    <div class="form-group">
      <label for="{{ form.content.id_for_label }}">Contenido</label>
      {{ form.content }}
    </div>

    <div class="form-group">
      <label for="{{ form.tipo.id_for_label }}">Tipo</label>
      {{ form.tipo }}
    </div>

    <h4>Comidas</h4>
    {{ formset.management_form }}

    <div id="formset-area">
      {% for f in formset %}
      <div class="form-row" data-form-index="{{ forloop.counter0 }}">
        <div class="form-group">
          {{ f.comida.label_tag }} {{ f.comida }}
        </div>
        <div class="form-group">
          {{ f.cantidad.label_tag }} {{ f.cantidad }}
        </div>
        <div class="form-group">
          {% if f.instance.pk %}
          <label>Eliminar</label>
          {{ f.DELETE }}
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <button type="button" id="add-form" class="btn btn-secondary">Agregar comida</button>

    <div id="empty-form-template" style="display:none;">
      {{ formset.empty_form.as_p|safe }}
    </div>

    <script>
      (function () {
        // Busca el input TOTAL_FORMS (funciona con el prefijo que sea)
        const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
        if (!totalFormsInput) {
          console.error('No se encontró TOTAL_FORMS. Asegúrate de incluir {{ formset.management_form }}');
          return;
        }

        const formsetArea = document.getElementById('formset-area');
        const addBtn = document.getElementById('add-form');
        const emptyTemplateHtml = document.getElementById('empty-form-template').innerHTML;

        addBtn.addEventListener('click', function () {
          const currentIndex = parseInt(totalFormsInput.value, 10);

          // Reemplaza todos los __prefix__ del empty_form por el índice actual
          const re = new RegExp('__prefix__', 'g');
          const newFormHtml = emptyTemplateHtml.replace(re, currentIndex);

          // Convertir string a DOM node y limpiar valores por si hay algo
          const wrapper = document.createElement('div');
          wrapper.className = 'form-row';
          wrapper.setAttribute('data-form-index', currentIndex);
          wrapper.innerHTML = newFormHtml;

          // Limpia selects/inputs (normalmente empty_form viene vacío, pero por si acaso)
          wrapper.querySelectorAll('input, select, textarea').forEach(function (el) {
            if (el.type === 'checkbox' || el.type === 'radio') {
              el.checked = false;
            } else {
              el.value = '';
            }
          });

          formsetArea.appendChild(wrapper);

          // Incrementa TOTAL_FORMS
          totalFormsInput.value = currentIndex + 1;
        });
      })();
    </script>

    <button type="submit">Guardar plan</button>
    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
      <a href="{% url 'index' %}" class="btn-cancelar">Cancelar</a>
    </div>

  </form>
</div>
{% endblock content %}